<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColorAid – Corrección Rápida y Test Ishihara Real</title>

<style>
    body { margin:0; font-family:Arial, sans-serif; background:#f2f2f2; text-align:center; padding-bottom: 50px; }
    header { background:#005bbb; padding:15px; color:white; font-size:22px; font-weight: bold; }
    h2 { margin-top:25px; color: #333; }
    
    .mode-container, .test-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        padding: 10px;
    }

    .mode-btn, .action-btn, .close-btn, #testStartBtn, .test-input-btn {
        background:white; padding:12px; 
        width: 100%; max-width:300px; border-radius:10px;
        border-left:6px solid #007bff; cursor:pointer;
        font-size:16px; user-select: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin: 5px auto;
        transition: transform 0.1s;
    }
    
    .mode-btn:active, .action-btn:active, #testStartBtn:active { transform: scale(0.98); }
    .action-btn { background:#007bff; color:white; border-left:none; }
    .close-btn { background:#ff3b3b; color:white; border-left:none; display: none; }
    
    .test-step {
        background: white;
        padding: 20px;
        margin: 20px auto;
        max-width: 450px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        display: none; 
        text-align: left;
    }

    .test-step input[type="number"] {
        padding: 10px;
        font-size: 18px;
        width: 100px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    canvas {
        width:90%; max-width:400px; margin-top:15px;
        border-radius:10px; background:#ddd;
        display: block; margin-left: auto; margin-right: auto;
    }

    #videoElement { display: none; }
</style>
</head>

<body>

<header>ColorAid – Corrección y Test</header>

<h2>1. Selecciona el modo de corrección</h2>
<div class="mode-container">
    <div class="mode-btn" onclick="setMatrix('deuteranopia')">Deuteranopia</div>
    <div class="mode-btn" onclick="setMatrix('protanopia')">Protanopia</div>
    <div class="mode-btn" onclick="setMatrix('tritanopia')">Tritanopia</div>
</div>

<h2>2. Subir imagen</h2>
<input type="file" id="imageInput" accept="image/*">
<canvas id="imageCanvas"></canvas>

<h2>3. Cámara en vivo</h2>
<div class="action-btn" id="btnStart" onclick="startCamera()">Activar cámara</div>
<div class="close-btn" id="btnStop" onclick="stopCamera()">Detener cámara</div>
<canvas id="videoCanvas" style="display:none;"></canvas>
<video id="videoElement" autoplay playsinline></video>

<hr>

<h2>4. Test de Color Ishihara (Placas reales)</h2>
<div class="action-btn" id="testStartBtn" onclick="startTest()">Iniciar Test</div>

<canvas id="testCanvas" style="display:none;"></canvas>

<div class="test-step" id="testInputBox">
    <p>¿Qué número ves?</p>
    <input type="number" id="testAnswer">
    <div class="test-input-btn" onclick="submitAnswer()">Responder</div>
</div>

<div id="testResult" style="margin:20px; font-size:18px; font-weight:bold; color:#005bbb;"></div>

<script>
// ---------------- MATRICES DE CORRECCIÓN ----------------
let selectedMatrix = null;

const matrices = {
    deuteranopia: [
        [0.625, 0.375, 0.000],
        [0.700, 0.300, 0.000],
        [0.000, 0.300, 0.700]
    ],
    protanopia: [
        [0.567, 0.433, 0.000],
        [0.558, 0.442, 0.000],
        [0.000, 0.242, 0.758]
    ],
    tritanopia: [
        [0.950, 0.050, 0.000],
        [0.000, 0.433, 0.567],
        [0.000, 0.475, 0.525]
    ]
};

function setMatrix(type){
    selectedMatrix = matrices[type];
    alert("Modo activado: " + type);
    if(originalImg.src && !cameraRunning) applyMatrixToImage();
}

// ---------------- SUBIR IMAGEN ----------------
let originalImg = new Image();
const imageCanvas = document.getElementById("imageCanvas");
const imgCtx = imageCanvas.getContext("2d");

document.getElementById("imageInput").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;

    if(cameraRunning) stopCamera();

    const reader = new FileReader();
    reader.onload = function(event){
        originalImg = new Image();
        originalImg.onload = function(){
            const scale = 800 / originalImg.width;
            imageCanvas.width = 800;
            imageCanvas.height = originalImg.height * scale;

            imgCtx.drawImage(originalImg, 0, 0, imageCanvas.width, imageCanvas.height);

            if(selectedMatrix) applyMatrixToImage();
        }
        originalImg.src = event.target.result;
    }
    reader.readAsDataURL(file);
});

function applyMatrixToImage(){
    if(!selectedMatrix) return;
    
    imgCtx.drawImage(originalImg, 0, 0, imageCanvas.width, imageCanvas.height);

    let imgData = imgCtx.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
    filterData(imgData.data, selectedMatrix);
    imgCtx.putImageData(imgData, 0, 0);
}

// ---------------- FILTRO ----------------
function filterData(data, m){
    for(let i=0; i<data.length; i+=4){
        let r = data[i], g = data[i+1], b = data[i+2];

        let nr = r*m[0][0] + g*m[0][1] + b*m[0][2];
        let ng = r*m[1][0] + g*m[1][1] + b*m[1][2];
        let nb = r*m[2][0] + g*m[2][1] + b*m[2][2];

        data[i]   = Math.min(255, Math.max(0, nr));
        data[i+1] = Math.min(255, Math.max(0, ng));
        data[i+2] = Math.min(255, Math.max(0, nb));
    }
}

// ---------------- CÁMARA ----------------
let cameraStream = null;
let cameraRunning = false;
let animationId = null;

const videoCanvas = document.getElementById("videoCanvas");
const videoElement = document.getElementById("videoElement");
const vidCtx = videoCanvas.getContext("2d", { willReadFrequently: true });

function startCamera(){
    navigator.mediaDevices.getUserMedia({ video:{ facingMode: "environment" }})
    .then(stream => {
        cameraStream = stream;
        videoElement.srcObject = stream;
        cameraRunning = true;

        document.getElementById("videoCanvas").style.display = "block";
        document.getElementById("btnStart").style.display = "none";
        document.getElementById("btnStop").style.display = "block";

        requestAnimationFrame(processCamera);
    });
}

function stopCamera(){
    cameraRunning = false;
    if(cameraStream){
        cameraStream.getTracks().forEach(track => track.stop());
    }
    document.getElementById("btnStart").style.display = "block";
    document.getElementById("btnStop").style.display = "none";
    videoCanvas.style.display = "none";
}

function processCamera(){
    if(!cameraRunning) return;

    videoCanvas.width = videoElement.videoWidth;
    videoCanvas.height = videoElement.videoHeight;

    vidCtx.drawImage(videoElement, 0, 0);

    if(selectedMatrix){
        let frame = vidCtx.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
        filterData(frame.data, selectedMatrix);
        vidCtx.putImageData(frame, 0, 0);
    }

    animationId = requestAnimationFrame(processCamera);
}

// ---------------- TEST ISHIHARA REAL ----------------
const testCanvas = document.getElementById("testCanvas");
const testCtx = testCanvas.getContext("2d");

let plates = [
    { src: "plates/12.jpg", answer: 12 },
    { src: "plates/8.jpg", answer: 8 },
    { src: "plates/29.jpg", answer: 29 },
    { src: "plates/57.jpg", answer: 57 },
    { src: "plates/5.jpg", answer: 5 },
    { src: "plates/3.jpg", answer: 3 }
];

let step = 0;
let correct = 0;

function startTest(){
    stopCamera();

    step = 0;
    correct = 0;

    document.getElementById("testResult").textContent = "";
    document.getElementById("testStartBtn").style.display = "none";

    nextPlate();
}

function nextPlate(){
    step++;

    if(step > plates.length){
        finishTest();
        return;
    }

    const img = new Image();
    img.onload = function(){
        testCanvas.style.display = "block";

        testCanvas.width = 350;
        testCanvas.height = 350;

        testCtx.drawImage(img, 0, 0, 350, 350);
    };
    img.src = plates[step-1].src;

    document.getElementById("testAnswer").value = "";
    document.getElementById("testInputBox").style.display = "block";
}

function submitAnswer(){
    const user = parseInt(document.getElementById("testAnswer").value);
    const correctAns = plates[step-1].answer;

    if(user === correctAns) correct++;

    if(selectedMatrix){
        let imgData = testCtx.getImageData(0, 0, 350, 350);
        filterData(imgData.data, selectedMatrix);
        testCtx.putImageData(imgData, 0, 0);

        alert("Placa corregida con ColorAid.\nObserva si ahora ves mejor el número.");
        setTimeout(nextPlate, 2000);
    } else {
        nextPlate();
    }
}

function finishTest(){
    testCanvas.style.display = "none";
    document.getElementById("testInputBox").style.display = "none";
    document.getElementById("testStartBtn").style.display = "block";

    let msg = `Aciertos: ${correct} de ${plates.length}. `;

    if(correct === plates.length){
        msg += "No se observan indicios de daltonismo.";
    } else if(correct >= plates.length / 2){
        msg += "Podrías tener una deficiencia leve.";
    } else {
        msg += "Alto indicio de daltonismo. Se recomienda evaluación profesional.";
    }

    document.getElementById("testResult").textContent = msg;
}

</script>

</body>
</html>

