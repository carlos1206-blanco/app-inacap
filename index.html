<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColorAid PRO</title>

<style>
*{box-sizing:border-box;}
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f2f2f2;
}

/* HEADER */
header{
    background:#005bbb;
    color:white;
    padding:15px;
    font-size:22px;
    display:flex;
    align-items:center;
}
#menuBtn{
    font-size:26px;
    background:none;
    border:none;
    color:white;
    margin-right:15px;
    cursor:pointer;
}

/* OVERLAY */
#overlay{
    display:none;
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.4);
    z-index:900;
}

/* MENU */
#menu{
    position:fixed;
    top:0;
    left:-260px;
    width:260px;
    height:100vh;
    background:white;
    box-shadow:2px 0 10px rgba(0,0,0,.3);
    padding:20px;
    transition:.3s;
    z-index:1000;
}
#menu.open{left:0;}

.menu-title{
    font-weight:bold;
    margin:15px 0 5px;
}
.menu-btn{
    width:100%;
    padding:10px;
    margin:4px 0;
    border:none;
    border-radius:5px;
    background:#007bff;
    color:white;
    cursor:pointer;
}
.menu-btn.close{
    background:#dc3545;
}

/* MAIN */
main{
    padding:20px;
    text-align:center;
}

/* canvas principal */
#canvas{
    display:none;
    width:100%;
    max-width:360px;
    margin:15px auto;
    border-radius:10px;
    box-shadow:0 4px 8px rgba(0,0,0,.2);
}

/* TEST */
#testArea{
    display:none;
    margin-top:20px;
}
#testCanvas{
    display:block; /* üîë ESTE ERA EL PROBLEMA */
    width:300px;
    height:300px;
    margin:10px auto;
    border-radius:10px;
    box-shadow:0 4px 8px rgba(0,0,0,.2);
}

input[type=file]{display:none;}
input[type=number]{
    padding:8px;
    width:150px;
}
</style>
</head>

<body>

<header>
    <button id="menuBtn">‚ò∞</button>
    ColorAid PRO
</header>

<div id="overlay"></div>

<!-- MENU -->
<div id="menu">
    <button class="menu-btn close" onclick="closeMenu()">‚ùå Cerrar men√∫</button>

    <div class="menu-title">Imagen</div>
    <button class="menu-btn" onclick="imageInput.click()">üìÅ Subir imagen</button>

    <div class="menu-title">Filtros</div>
    <button class="menu-btn" onclick="setFilter('deuteranopia')">Deuteranopia</button>
    <button class="menu-btn" onclick="setFilter('protanopia')">Protanopia</button>
    <button class="menu-btn" onclick="setFilter('tritanopia')">Tritanopia</button>
    <button class="menu-btn" onclick="setFilter(null)">Sin filtro</button>

    <div class="menu-title">C√°mara</div>
    <button class="menu-btn" onclick="startCamera()">üì∑ Abrir c√°mara</button>
    <button class="menu-btn" onclick="stopCamera()">‚õî Cerrar c√°mara</button>

    <div class="menu-title">Test</div>
    <button class="menu-btn" onclick="startTest()">üß† Test visual</button>
</div>

<!-- MAIN -->
<main>
    <input type="file" id="imageInput" accept="image/*">
    <canvas id="canvas"></canvas>

    <!-- TEST -->
    <div id="testArea">
        <h3>Test visual</h3>
        <canvas id="testCanvas" width="300" height="300"></canvas>
        <br>
        <input id="answer" type="number" placeholder="N√∫mero que ves">
        <br><br>
        <button class="menu-btn" onclick="submitAnswer()">Responder</button>
        <button class="menu-btn close" onclick="closeTest()">Cerrar test</button>
    </div>

    <div id="result"></div>
</main>

<script>
// ================= MENU =================
const menu=document.getElementById("menu");
const overlay=document.getElementById("overlay");
document.getElementById("menuBtn").onclick=openMenu;
overlay.onclick=closeMenu;

function openMenu(){
    menu.classList.add("open");
    overlay.style.display="block";
}
function closeMenu(){
    menu.classList.remove("open");
    overlay.style.display="none";
}

// ================= FILTROS =================
const matrices={
    deuteranopia:[[0.625,0.375,0],[0.7,0.3,0],[0,0.3,0.7]],
    protanopia:[[0.567,0.433,0],[0.558,0.442,0],[0,0.242,0.758]],
    tritanopia:[[0.95,0.05,0],[0,0.433,0.567],[0,0.475,0.525]]
};
let currentMatrix=null;

// ================= CANVAS PRINCIPAL =================
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let originalImage=null;

// ================= SUBIR IMAGEN =================
const imageInput=document.getElementById("imageInput");
imageInput.onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=()=>{
        const img=new Image();
        img.onload=()=>{
            canvas.style.display="block";
            canvas.width=img.width;
            canvas.height=img.height;
            ctx.drawImage(img,0,0);
            originalImage=ctx.getImageData(0,0,canvas.width,canvas.height);
            applyFilter();
        };
        img.src=reader.result;
    };
    reader.readAsDataURL(file);
    closeMenu();
};

// ================= APLICAR FILTRO =================
function setFilter(type){
    currentMatrix=type?matrices[type]:null;
    applyFilter();
    closeMenu();
}
function applyFilter(){
    if(!originalImage)return;
    ctx.putImageData(originalImage,0,0);
    if(!currentMatrix)return;
    let img=ctx.getImageData(0,0,canvas.width,canvas.height);
    let d=img.data,m=currentMatrix;
    for(let i=0;i<d.length;i+=4){
        let r=d[i],g=d[i+1],b=d[i+2];
        d[i]=r*m[0][0]+g*m[0][1]+b*m[0][2];
        d[i+1]=r*m[1][0]+g*m[1][1]+b*m[1][2];
        d[i+2]=r*m[2][0]+g*m[2][1]+b*m[2][2];
    }
    ctx.putImageData(img,0,0);
}

// ================= CAMARA =================
let stream=null;
async function startCamera(){
    try{
        stream=await navigator.mediaDevices.getUserMedia({video:true});
        const video=document.createElement("video");
        video.srcObject=stream;
        video.play();
        video.onloadedmetadata=()=>{
            canvas.style.display="block";
            canvas.width=video.videoWidth;
            canvas.height=video.videoHeight;
            function loop(){
                if(!stream)return;
                ctx.drawImage(video,0,0);
                requestAnimationFrame(loop);
            }
            loop();
        };
        closeMenu();
    }catch(e){
        alert("No se pudo acceder a la c√°mara");
    }
}
function stopCamera(){
    if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream=null;
    }
}

// ================= TEST VISUAL =================
const numbers=[12,8,29,5];
let idx=0;
const testCanvas=document.getElementById("testCanvas");
const tCtx=testCanvas.getContext("2d");

function drawIshihara(num){
    tCtx.clearRect(0,0,300,300);

    for(let i=0;i<1500;i++){
        tCtx.fillStyle=`hsl(${Math.random()*360},70%,60%)`;
        tCtx.beginPath();
        tCtx.arc(Math.random()*300,Math.random()*300,Math.random()*5+3,0,Math.PI*2);
        tCtx.fill();
    }

    tCtx.fillStyle="rgba(0,0,0,0.35)";
    tCtx.font="bold 90px Arial";
    tCtx.textAlign="center";
    tCtx.textBaseline="middle";
    tCtx.fillText(num,150,150);
}

function startTest(){
    idx=0;
    document.getElementById("testArea").style.display="block";
    drawIshihara(numbers[idx]);
    closeMenu();
}
function submitAnswer(){
    const val=parseInt(document.getElementById("answer").value);
    const ok=numbers[idx];
    document.getElementById("result").textContent=
        val===ok?"‚úÖ Correcto":"‚ùå Incorrecto (era "+ok+")";
    idx++;
    if(idx<numbers.length){
        setTimeout(()=>drawIshihara(numbers[idx]),1200);
    }else{
        setTimeout(()=>{
            document.getElementById("result").textContent+=" ‚Äî Test finalizado";
        },1200);
    }
}
function closeTest(){
    document.getElementById("testArea").style.display="none";
}
</script>

</body>
</html>

