<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColorAid PRO</title>

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Arial;background:#f2f2f2}
header{
    background:#005bbb;color:#fff;padding:15px;
    font-size:22px;display:flex;align-items:center
}
#menuBtn{font-size:26px;background:none;border:none;color:white;margin-right:15px}

#overlay{
    display:none;position:fixed;inset:0;
    background:rgba(0,0,0,.4);z-index:900
}
#menu{
    position:fixed;top:0;left:-260px;width:260px;height:100vh;
    background:#fff;padding:20px;box-shadow:2px 0 10px rgba(0,0,0,.3);
    transition:.3s;z-index:1000
}
#menu.open{left:0}

.menu-title{font-weight:bold;margin:15px 0 5px}
.menu-btn{
    width:100%;padding:10px;margin:4px 0;
    border:none;border-radius:5px;background:#007bff;color:white
}
.menu-btn.close{background:#dc3545}

main{text-align:center;padding:20px}

#canvas{
    display:none;margin:15px auto;max-width:360px;width:100%;
    border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.2)
}

#testArea{display:none;margin-top:20px}
#testCanvas{
    width:300px;height:300px;border-radius:50%;
    box-shadow:0 4px 8px rgba(0,0,0,.2)
}

input[type=file]{display:none}
input[type=number]{padding:8px;width:150px}
</style>
</head>

<body>

<header>
    <button id="menuBtn">‚ò∞</button>
    ColorAid PRO
</header>

<div id="overlay"></div>

<div id="menu">
    <button class="menu-btn close" onclick="closeMenu()">‚ùå Cerrar</button>

    <div class="menu-title">Imagen</div>
    <button class="menu-btn" onclick="imageInput.click()">üìÅ Subir imagen</button>

    <div class="menu-title">Filtros</div>
    <button class="menu-btn" onclick="setFilter(null)">Sin filtro</button>
    <button class="menu-btn" onclick="setFilter('deuteranopia')">Deuteranopia</button>
    <button class="menu-btn" onclick="setFilter('protanopia')">Protanopia</button>
    <button class="menu-btn" onclick="setFilter('tritanopia')">Tritanopia</button>

    <div class="menu-title">C√°mara</div>
    <button class="menu-btn" onclick="startCamera()">üì∑ Abrir c√°mara</button>
    <button class="menu-btn close" onclick="stopCamera()">‚õî Cerrar c√°mara</button>

    <div class="menu-title">Test</div>
    <button class="menu-btn" onclick="startTest()">üß† Test crom√°tico</button>
</div>

<main>
    <input type="file" id="imageInput" accept="image/*">
    <canvas id="canvas"></canvas>

    <div id="testArea">
        <h3>Test de percepci√≥n crom√°tica</h3>
        <canvas id="testCanvas" width="300" height="300"></canvas><br>
        <input id="answer" type="number" placeholder="N√∫mero que ves"><br><br>
        <button class="menu-btn" onclick="submitAnswer()">Responder</button>
        <button class="menu-btn close" onclick="closeTest()">Cerrar test</button>
    </div>

    <div id="result"></div>
</main>

<script>
// ===== MEN√ö =====
menuBtn.onclick=()=>{menu.classList.add("open");overlay.style.display="block"}
overlay.onclick=closeMenu
function closeMenu(){menu.classList.remove("open");overlay.style.display="none"}

// ===== FILTROS =====
let filter=null
function setFilter(f){filter=f;applyFilter();closeMenu()}

// ===== CANVAS PRINCIPAL =====
const canvas=document.getElementById("canvas")
const ctx=canvas.getContext("2d")
let originalImage=null

// ===== SUBIR IMAGEN =====
imageInput.onchange=e=>{
    const reader=new FileReader()
    reader.onload=()=>{
        const img=new Image()
        img.onload=()=>{
            canvas.style.display="block"
            canvas.width=img.width
            canvas.height=img.height
            ctx.drawImage(img,0,0)
            originalImage=ctx.getImageData(0,0,canvas.width,canvas.height)
            applyFilter()
        }
        img.src=reader.result
    }
    reader.readAsDataURL(e.target.files[0])
    closeMenu()
}

// ===== APLICAR FILTROS A IMAGEN / C√ÅMARA =====
function applyFilter(){
    if(!originalImage)return
    ctx.putImageData(originalImage,0,0)
    if(!filter)return
    let img=ctx.getImageData(0,0,canvas.width,canvas.height)
    let d=img.data
    for(let i=0;i<d.length;i+=4){
        if(filter==="deuteranopia") d[i+1]*=0.6
        if(filter==="protanopia") d[i]*=0.6
        if(filter==="tritanopia") d[i+2]*=0.6
    }
    ctx.putImageData(img,0,0)
}

// ===== C√ÅMARA =====
let stream=null
async function startCamera(){
    try{
        stream=await navigator.mediaDevices.getUserMedia({video:true})
        const video=document.createElement("video")
        video.srcObject=stream
        video.play()
        video.onloadedmetadata=()=>{
            canvas.style.display="block"
            canvas.width=video.videoWidth
            canvas.height=video.videoHeight
            function loop(){
                if(!stream)return
                ctx.drawImage(video,0,0)
                originalImage=ctx.getImageData(0,0,canvas.width,canvas.height)
                applyFilter()
                requestAnimationFrame(loop)
            }
            loop()
        }
        closeMenu()
    }catch{alert("No se pudo acceder a la c√°mara")}
}
function stopCamera(){
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}
}

// ===== TEST CROM√ÅTICO (INDEPENDIENTE) =====
const plates=[
 {number:12,fg:[220,60,60],bg:[80,170,80]},
 {number:8, fg:[60,180,60],bg:[200,90,90]},
 {number:29,fg:[60,90,200],bg:[200,200,80]}
]
let idx=0
const tCtx=testCanvas.getContext("2d")

function drawPlate(p){
    tCtx.clearRect(0,0,300,300)
    for(let i=0;i<1600;i++){
        let c=Math.random()<0.35?p.fg:p.bg
        tCtx.fillStyle=`rgb(${c[0]},${c[1]},${c[2]})`
        tCtx.beginPath()
        tCtx.arc(Math.random()*300,Math.random()*300,Math.random()*5+3,0,Math.PI*2)
        tCtx.fill()
    }
    tCtx.globalCompositeOperation="destination-in"
    tCtx.font="bold 110px Arial"
    tCtx.textAlign="center"
    tCtx.textBaseline="middle"
    tCtx.fillText(p.number,150,150)
    tCtx.globalCompositeOperation="source-over"
}

function startTest(){
    idx=0
    answer.value=""
    result.textContent=""
    testArea.style.display="block"
    drawPlate(plates[idx])
    closeMenu()
}
function submitAnswer(){
    const ok=plates[idx].number
    result.textContent=answer.value==ok?"‚úÖ Correcto":"‚ùå Incorrecto (era "+ok+")"
    idx++
    answer.value=""
    if(idx<plates.length){
        setTimeout(()=>drawPlate(plates[idx]),1200)
    }else{
        setTimeout(()=>result.textContent+=" ‚Äî Test finalizado",1200)
    }
}
function closeTest(){testArea.style.display="none"}
</script>

</body>
</html>




